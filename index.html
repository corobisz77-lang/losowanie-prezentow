<script>
/* ---- POPRAWIONE: bez wczeÅ›niejszego blokowania input, lepszy handling bÅ‚Ä™dÃ³w ---- */

const osoby = [
    "Bogusia","Bronek","MaÅ‚gorzata","PaweÅ‚","Julia","Kamil",
    "Agnieszka","Ewelina","Mariusz","Lucyna","Daniel"
];

const blokady = {
    "Bogusia":["Bronek"],
    "Bronek":["Bogusia"],
    "PaweÅ‚":["MaÅ‚gorzata"],
    "MaÅ‚gorzata":["PaweÅ‚"],
    "Julia":["Kamil"],
    "Kamil":["Julia"],
    "Ewelina":["Mariusz"],
    "Mariusz":["Ewelina"],
    "Lucyna":["Daniel"],
    "Daniel":["Lucyna"]
};

const firebaseConfig = {
    apiKey: "AIzaSyDCCpqTPCnMZ7Sda3lS1sC82q9HfZ9BRVc",
    authDomain: "losowanie-cd801.firebaseapp.com",
    databaseURL: "https://losowanie-cd801-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "losowanie-cd801",
    storageBucket: "losowanie-cd801.firebasestorage.app",
    messagingSenderId: "309302443421",
    appId: "1:309302443421:web:7bc0bb3e5ce619d7c55275"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// WyÅ›wietl komunikat w #wynik
function showMessage(text, isError = false) {
    const el = document.getElementById("wynik");
    el.style.color = isError ? "#ffdddd" : "#ffe8c2";
    el.innerText = text;
}

// Pobierz dane z Firebase, ale obsÅ‚uÅ¼ bÅ‚Ä™dy
async function pobierzDane() {
    try {
        const snap = await db.ref("losowanie").get();
        if (!snap.exists()) {
            // JeÅ›li brak danych, utwÃ³rz startowÄ… strukturÄ™
            const start = { wyniki: {}, dostepni: [...osoby] };
            await db.ref("losowanie").set(start);
            return start;
        }
        return snap.val();
    } catch (err) {
        console.error("BÅ‚Ä…d pobierania z Firebase:", err);
        // ZwrÃ³Ä‡ lokalny stan jako fallback Å¼eby UI dziaÅ‚aÅ‚ (ale nie zapisze nic do DB)
        return { wyniki: {}, dostepni: [...osoby], _error: err };
    }
}

// Zapisz dane do Firebase z obsÅ‚ugÄ… bÅ‚Ä™dÃ³w
async function zapiszDane(wyniki, dostepni) {
    try {
        await db.ref("losowanie").set({ wyniki, dostepni });
        return { ok: true };
    } catch (err) {
        console.error("BÅ‚Ä…d zapisu do Firebase:", err);
        return { ok: false, error: err };
    }
}

// Przy Å‚adowaniu strony: jeÅ›li localStorage ma imiÄ™, wstaw je ale NIE BLOKUJ od razu.
// BlokadÄ™ ustawimy dopiero po UDANYM zapisie do Firebase.
window.addEventListener("load", () => {
    const saved = localStorage.getItem("moje_imie");
    if (saved) {
        document.getElementById("mojeImie").value = saved;
        // NIE disable tutaj â€” dopiero po pewnym potwierdzeniu zapisu
    }
});

// GÅ‚Ã³wna funkcja losowania
async function losuj() {
    const input = document.getElementById("mojeImie");
    let imie = input.value.trim();
    imie = imie.charAt(0).toUpperCase() + imie.slice(1).toLowerCase();

    if (!imie) {
        alert("Wpisz swoje imiÄ™!");
        return;
    }
    if (!osoby.includes(imie)) {
        alert("Nie ma takiej osoby!");
        return;
    }

    showMessage("ğŸ”„ Sprawdzam dane...");

    // Pobierz dane z bazy (lub fallback)
    const data = await pobierzDane();

    if (data._error) {
        // JeÅ›li pobieranie siÄ™ nie powiodÅ‚o â€” poinformuj uÅ¼ytkownika i nie blokuj inputa
        showMessage("â— Nie moÅ¼na poÅ‚Ä…czyÄ‡ siÄ™ z bazÄ…. SprawdÅº internet / rules Firebase.", true);
        return;
    }

    const wyniki = data.wyniki || {};
    let dostepni = Array.isArray(data.dostepni) ? data.dostepni : [...osoby];

    // JeÅ›li juÅ¼ w bazie osoba ma wynik â€” pokaÅ¼ go i zakoÅ„cz (bez blokowania inputu jeszcze)
    if (wyniki[imie]) {
        showMessage(`ğŸ JuÅ¼ losowaÅ‚eÅ›!\nTwÃ³j prezent kupujesz dla: ${wyniki[imie]}`);
        // Zapisz imiÄ™ lokalnie i zablokuj pole â€” bo uÅ¼ytkownik juÅ¼ ma wynik
        localStorage.setItem("moje_imie", imie);
        input.disabled = true;
        return;
    }

    // Wylicz moÅ¼liwe osoby
    let mozliwe = dostepni.filter(o => o !== imie && !(blokady[imie] || []).includes(o));
    if (mozliwe.length === 0) {
        showMessage("â— Brak dostÄ™pnych osÃ³b do wylosowania.", true);
        return;
    }

    // Losuj
    const wylosowane = mozliwe[Math.floor(Math.random() * mozliwe.length)];

    // Zaktualizuj lokalnie
    wyniki[imie] = wylosowane;
    dostepni = dostepni.filter(o => o !== wylosowane);

    showMessage("ğŸ” ZapisujÄ™ wynik...");

    // SprÃ³buj zapisaÄ‡ w Firebase; jeÅ›li zapis siÄ™ nie uda, cofnij lokalne zmiany i poinformuj
